{% extends "global/Page.html" %}
{% load otree %}

{% block understanding_testing_styles %}
<style>
  .qn-container {
    margin-bottom: 2rem;
  }
</style>
{% endblock %}

{% block understanding_testing_scripts %}
<script>
  const form = document.getElementById("form");
  const choice0 = document.getElementById("choice0");
  const choice1 = document.getElementById("choice1");
  const choice2 = document.getElementById("choice2");
  const choice3 = document.getElementById("choice3");
  const nextButton = document.querySelector('.otree-btn-next');

  function insertAfter(newNode, referenceNode) {
    referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
  }

  function createWarning() {
    const warning = document.createElement("p");
    warning.innerText = "Your answer is not correct. Please try again.";
    warning.style.color = "red";
    return warning;
  }

  function showWarning() {
    insertAfter(createWarning(), form);
  }

  if (js_vars.qn_status === "fail_1") {
    showWarning();
  }

  function getChoices() {
    return [choice0.checked, choice1.checked, choice2.checked, choice3.checked];
  }

  function areArraysEqual(array1, array2) {
    return array1.length === array2.length &&
      array1.every((value, index) => value === array2[index]);
  }

  function addFormValidation(correctCheckedValues) {
    form.addEventListener("submit", (evt) => {
      if (js_vars.qn_status === "fail_2") {
        return;
      }

      choices = getChoices();
      isCorrect = areArraysEqual(correctCheckedValues, choices);

      if (isCorrect) {
        liveSend({ choices, status: "pass" });
      } else if (js_vars.qn_status === "unanswered") {
        liveSend({ choices, status: "fail_1" });
        js_vars.qn_status = "fail_1";
        showWarning();
        evt.preventDefault();
        nextButton.disabled = true;
      } else if (js_vars.qn_status === "fail_1") {
        liveSend({ choices, status: "fail_2" });
        js_vars.qn_status = "fail_2";
      }
    });
  }

  function countCheckedChoices() {
    return [choice0, choice1, choice2, choice3].reduce((prev, cur) => prev + cur.checked, 0);
  }

  function handleChoiceChange() {
    nextButton.disabled = countCheckedChoices() != 2;
  }

  [choice0, choice1, choice2, choice3].forEach((c) => c.addEventListener('change', handleChoiceChange));
  handleChoiceChange()


</script>
{% endblock %}